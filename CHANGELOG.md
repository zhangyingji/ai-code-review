# 更新日志

## [v2.3.0] - 2025-11-23

### 🎯 重构

- **报告生成系统模块化重构**：将单一的 report_generator.py 拆分为多个专用模块
  - 创建 `formatters/` 模块：独立处理不同报告格式
    - `BaseFormatter` 抽象基类，定义统一接口
    - `HtmlFormatter`：HTML报告生成
    - `MarkdownFormatter`：Markdown报告生成
    - `JsonFormatter`：JSON报告生成
    - `ExcelFormatter`：Excel报告生成
  - 创建 `templates/` 模块：集中管理HTML模板和样式
    - `html_template.py`：HTML结构模板
    - `styles.py`：CSS样式定义
    - JavaScript 脚本独立管理
  - 创建 `utils/` 模块：通用工具函数
    - `DataProcessor`：数据排序、分组、筛选功能
    - `helpers.py`：文件名清理、时间格式化等辅助函数

### 🏗️ 架构扩展

- **存储模块** (`storage/`)：为评审结果数据库落库预留接口
  - `BaseStorage` 抽象基类
  - `DatabaseStorage` 示例实现框架
  - 支持保存、查询、删除、统计功能

- **集成模块** (`integrations/`)：为外部系统对接预留接口
  - `BaseIntegration` 抽象基类
  - `GerritIntegration`：Gerrit代码审查系统集成框架
  - `GitLabIntegration`：GitLab增强集成框架
  - 支持获取MR、发布评论、设置审查状态

- **调度模块** (`schedulers/`)：为定时评审任务预留接口
  - `BaseScheduler` 抽象基类
  - `CronScheduler`：Cron表达式调度框架
  - 支持APScheduler等成熟库的集成

### ✨ 核心改进

- **新报告生成器** (`report_generator_new.py`)：
  - 简化主接口到 120 行代码
  - 清晰的职责分离：选择格式化器 → 生成报告 → 保存文件
  - 支持一键生成多种格式报告
  - 灵活的格式化器扩展机制

- **数据处理工具** (`DataProcessor`)：
  - 提取问题排序、分组、筛选逻辑
  - 统一的数据处理接口
  - 被多个格式化器共享，提高代码复用

### 🔧 项目管理

- **更新 .gitignore**：
  - 添加演示脚本过滤：`demo_report.py`、`generate_demo_new.py`、`test_refactored.py`
  - 添加模板文件过滤：`simple_html_template.py`
  - 确保 `config.local.yaml` 不被跟踪

### 🎓 收益总结

**可维护性**：每个模块职责单一，通常 100-250 行代码，易于理解和修改

**可扩展性**：
- 新增报告格式：继承 `BaseFormatter` 即可
- 新增存储方式：实现 `BaseStorage` 接口
- 新增集成系统：实现 `BaseIntegration` 接口
- 新增调度方式：实现 `BaseScheduler` 接口

**可测试性**：每个模块可独立测试，依赖注入便于 mock

**代码复用**：工具函数、数据处理逻辑被多个模块共享

---

## [v2.1.0] - 2025-11-19

### 新增

- **Excel 报告格式支持**：新增 Excel (.xlsx) 格式报告生成
  - 包含多个工作表：概览、问题详情、文件评审、作者统计
  - 支持颜色编码区分严重程度（红色/橙色/黄色）
  - 问题详情中展示具体代码片段，按行号标注
  - 代码行颜色标识：新增（绿色）、删除（红色）、问题行（黄色）

- **HTML 报告代码段落展示**：为评审报告添加代码段落可视化
  - 显示问题所在的具体代码片段及上下文
  - 代码片段默认折叠，点击标题展开查看
  - 颜色编码区分代码行类型（新增/删除/普通）
  - 高亮显示问题所在行，便于快速定位

- **问题定位增强**：改进问题显示的定位信息
  - 显示具体的文件路径
  - 标注问题所在的行号范围
  - 识别并显示涉及的方法/函数名称

- **交互式仪表盘筛选**：添加按严重程度实时筛选功能
  - 点击仪表盘指标可按对应严重程度筛选问题
  - 支持快速切换不同的问题视图
  - 仪表盘项提供视觉反馈

### 优化

- **报告生成方法优化**：
  - generate_report() 方法现在支持 format='excel' 参数
  - Excel 报告自动删除默认的空白 Sheet
  - 改进问题数据收集和排序流程

- **代码段落展示**：
  - 支持显示新增/删除/上下文三种代码行
  - 自动扩展上下文（当前行前2行，后3行）
  - 正确处理多行代码段落的行号映射

- **LLM Prompt 优化**：增强大模型输出的结构化数据
  - 要求返回具体的行号（不允许 'N/A'）
  - 识别并返回方法/函数名称
  - 提供详细的格式示例和要求

### 修复

- **Excel Sheet 管理**：修复 openpyxl 创建时的默认空白 Sheet 问题
- **代码段落折叠状态**：修复代码段落默认显示状态，改为默认折叠
- **条件导入处理**：改进 openpyxl 的可选依赖处理，避免类型检查错误

### 技术栈更新

- 新增依赖：openpyxl（用于 Excel 报告生成）
- 保持向后兼容性：所有现有格式（HTML/Markdown/JSON）继续支持

### 报告功能对比

| 功能 | HTML | Excel | Markdown |
|------|------|-------|----------|
| 代码段落展示 | ✅ | ✅ | ❌ |
| 交互式筛选 | ✅ | ❌ | ❌ |
| 可折叠内容 | ✅ | ❌ | ❌ |
| 颜色编码 | ✅ | ✅ | ❌ |
| 离线支持 | ⚠️ | ✅ | ✅ |

---

## [v2.0.0] - 2025-11-19

### 新增

- **HTML 报告可折叠功能**：为提交人和文件区域添加展开/折叠功能，支持单个卡片折叠和批量操作
- **悬浮快速导航栏**：在页面右下角添加固定位置的悬浮导航按钮，包含展开/折叠所有提交人和文件的快捷操作
- **严重问题汇总区域**：添加独立的"严重问题汇总"展示区域，将所有严重问题以卡片网格形式展示，方便快速查看
- **问题按严重程度排序**：报告中的所有问题现在按严重程度排序（严重→主要→次要→建议）

### 优化

- **精简统计模块**：合并"关键指标概览"和"总体统计"，删除重复的统计信息，提升首屏清晰度
- **改进 HTML 报告布局**：
  - 仪表盘设计改为渐变背景，视觉更现代
  - 严重问题卡片采用响应式网格，支持多列自适应布局
  - 折叠功能支持平滑动画过渡（0.3s）
- **增强用户交互**：
  - 折叠图标添加悬停效果，提示可交互性
  - 按钮提供视觉反馈
  - 严重问题区域使用红色主题强调重要性
- **日志优化**：深度思考模式日志改为在初始化时打印一次，避免重复输出

### 修复

- **深度思考日志重复问题**：将"深度思考模式已启用"日志从 chat() 方法移至 __init__() 方法，仅在初始化时打印一次
- **API Key 处理**：确保 api_key 为可选参数，仅在非空时添加 Authorization 头，兼容无认证的本地服务
- **HTTPS 证书警告**：添加 urllib3 警告禁用和 requests verify=False，支持自签名证书

### 报告改进

**Markdown 报告：**
- 在"按提交人统计"和"文件评审详情"中显示问题所在的行号
- 严重问题优先显示，其他问题最多显示 10 个

**HTML 报告：**
- 交互式仪表盘展示关键指标（总问题数、各严重程度问题数、提交数等）
- 可折叠的提交人区域和文件区域，默认展开
- 悬浮导航按钮支持一键展开/折叠
- 严重问题卡片展示以下信息：
  - 提交人名称
  - 文件路径
  - 问题行号
  - 问题描述
  - 改进建议
- 所有问题按严重程度排序显示

### 技术栈保持

- Python 3.8+
- GitLab API
- OpenAI 兼容格式的大模型 API
- Jinja2 模板引擎
- ThreadPoolExecutor 并发处理

---

## [v1.0.0] - 2025-11-10

### 初始版本

- **核心功能**：
  - GitLab 集成，自动拉取代码差异
  - 大模型代码评审
  - 多格式报告生成（HTML/Markdown/JSON）
  - 按提交人分组统计

- **配置系统**：
  - YAML 配置文件
  - 支持本地配置覆盖（config.local.yaml）
  - 可配置的评审规则

- **性能优化**：
  - ThreadPoolExecutor 并发评审
  - 可配置的并发度（max_workers）

- **日志系统**：
  - 文件日志支持
  - 轮转日志处理
  - 多级别日志记录

- **深度思考模式**：
  - 支持通过消息标签（/think, /no_think）切换
  - 支持全局配置启用

- **分支管理**：
  - 支持指定源分支和基准分支
  - 基准分支为必输参数



