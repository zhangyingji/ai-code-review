# 更新日志

## [v2.2.0] - 2025-11-21

### 新增

- **多项目配置支持**：支持在单一配置文件中管理多个项目
  - 新增 `gitlab.projects` 配置项，允许配置项目列表
  - 使用 `-p/--project` 参数选择特定项目
  - 完全兼容现有的单项目配置方式

- **提交人过滤配置**：控制评审范围，按提交人筛选
  - 新增 `committer_filter.authors` 配置项
  - 当列表为空时评审所有提交人
  - 当列表非空时仅评审指定提交人的提交
  - 支持邮箱地址作为提交人标识

- **增强的评审规则**：
  - 支持评审规则分类名使用中文（如「代码风格」代替 `code_style`）
  - 新增「并发与线程安全」评审维度（6 条规则）
  - 性能模块新增 3 条规则：检查死循环、无限递归、资源泄漏
  - 新增「可维护性」评审维度（5 条规则）
  - 新增「文档注释」评审维度（4 条规则）
  - 现在共包含 7 个评审维度，29 条评审规则

- **报告优化**：
  - 去除 Markdown 报告中的「提交记录」展示
  - 保留关键的提交统计信息

### 优化

- **配置系统改进**：
  - 支持多项目切换，无需修改配置文件
  - 提交人过滤精确到邮箱级别
  - 评审规则配置更直观（支持中文分类名）

- **代码评审精细化**：
  - 增强对并发问题的检测（竞态条件、死锁、线程安全）
  - 增强对性能问题的检测（死循环、无限递归、资源泄漏）
  - 关注代码可维护性（命名、嵌套层级、代码复用）
  - 强调文档和注释的重要性

### 修复

- **文档显示优化**：移除 Markdown 报告中重复的提交信息展示

### 新增命令行参数

- `-p/--project`：在配置了多个项目时选择特定项目
  - 示例：`python main.py -p project-a`

### 配置示例

**多项目配置：**
```yaml
gitlab:
  url: "https://gitlab.example.com"
  private_token: "token"
  projects:
    - name: "project-a"
      id: 123
    - name: "project-b"
      id: 456
```

**提交人过滤配置：**
```yaml
committer_filter:
  authors:
    - "zhangsan@example.com"
    - "lisi@example.com"
```

**中文评审规则配置：**
```yaml
review_rules:
  代码风格:
    enabled: true
    rules:
      - "检查代码格式是否符合团队规范"
  安全性:
    enabled: true
    rules:
      - "检查是否有SQL注入风险"
  并发与线程安全:
    enabled: true
    rules:
      - "检查是否有死锁的可能性"
```

---

## [v2.1.0] - 2025-11-19

### 新增

- **Excel 报告格式支持**：新增 Excel (.xlsx) 格式报告生成
  - 包含多个工作表：概览、问题详情、文件评审、作者统计
  - 支持颜色编码区分严重程度（红色/橙色/黄色）
  - 问题详情中展示具体代码片段，按行号标注
  - 代码行颜色标识：新增（绿色）、删除（红色）、问题行（黄色）

- **HTML 报告代码段落展示**：为评审报告添加代码段落可视化
  - 显示问题所在的具体代码片段及上下文
  - 代码片段默认折叠，点击标题展开查看
  - 颜色编码区分代码行类型（新增/删除/普通）
  - 高亮显示问题所在行，便于快速定位

- **问题定位增强**：改进问题显示的定位信息
  - 显示具体的文件路径
  - 标注问题所在的行号范围
  - 识别并显示涉及的方法/函数名称

- **交互式仪表盘筛选**：添加按严重程度实时筛选功能
  - 点击仪表盘指标可按对应严重程度筛选问题
  - 支持快速切换不同的问题视图
  - 仪表盘项提供视觉反馈

### 优化

- **报告生成方法优化**：
  - generate_report() 方法现在支持 format='excel' 参数
  - Excel 报告自动删除默认的空白 Sheet
  - 改进问题数据收集和排序流程

- **代码段落展示**：
  - 支持显示新增/删除/上下文三种代码行
  - 自动扩展上下文（当前行前2行，后3行）
  - 正确处理多行代码段落的行号映射

- **LLM Prompt 优化**：增强大模型输出的结构化数据
  - 要求返回具体的行号（不允许 'N/A'）
  - 识别并返回方法/函数名称
  - 提供详细的格式示例和要求

### 修复

- **Excel Sheet 管理**：修复 openpyxl 创建时的默认空白 Sheet 问题
- **代码段落折叠状态**：修复代码段落默认显示状态，改为默认折叠
- **条件导入处理**：改进 openpyxl 的可选依赖处理，避免类型检查错误

### 技术栈更新

- 新增依赖：openpyxl（用于 Excel 报告生成）
- 保持向后兼容性：所有现有格式（HTML/Markdown/JSON）继续支持

### 报告功能对比

| 功能 | HTML | Excel | Markdown |
|------|------|-------|----------|
| 代码段落展示 | ✅ | ✅ | ❌ |
| 交互式筛选 | ✅ | ❌ | ❌ |
| 可折叠内容 | ✅ | ❌ | ❌ |
| 颜色编码 | ✅ | ✅ | ❌ |
| 离线支持 | ⚠️ | ✅ | ✅ |

---

## [v2.0.0] - 2025-11-19

### 新增

- **HTML 报告可折叠功能**：为提交人和文件区域添加展开/折叠功能，支持单个卡片折叠和批量操作
- **悬浮快速导航栏**：在页面右下角添加固定位置的悬浮导航按钮，包含展开/折叠所有提交人和文件的快捷操作
- **严重问题汇总区域**：添加独立的"严重问题汇总"展示区域，将所有严重问题以卡片网格形式展示，方便快速查看
- **问题按严重程度排序**：报告中的所有问题现在按严重程度排序（严重→主要→次要→建议）

### 优化

- **精简统计模块**：合并"关键指标概览"和"总体统计"，删除重复的统计信息，提升首屏清晰度
- **改进 HTML 报告布局**：
  - 仪表盘设计改为渐变背景，视觉更现代
  - 严重问题卡片采用响应式网格，支持多列自适应布局
  - 折叠功能支持平滑动画过渡（0.3s）
- **增强用户交互**：
  - 折叠图标添加悬停效果，提示可交互性
  - 按钮提供视觉反馈
  - 严重问题区域使用红色主题强调重要性
- **日志优化**：深度思考模式日志改为在初始化时打印一次，避免重复输出

### 修复

- **深度思考日志重复问题**：将"深度思考模式已启用"日志从 chat() 方法移至 __init__() 方法，仅在初始化时打印一次
- **API Key 处理**：确保 api_key 为可选参数，仅在非空时添加 Authorization 头，兼容无认证的本地服务
- **HTTPS 证书警告**：添加 urllib3 警告禁用和 requests verify=False，支持自签名证书

### 报告改进

**Markdown 报告：**
- 在"按提交人统计"和"文件评审详情"中显示问题所在的行号
- 严重问题优先显示，其他问题最多显示 10 个

**HTML 报告：**
- 交互式仪表盘展示关键指标（总问题数、各严重程度问题数、提交数等）
- 可折叠的提交人区域和文件区域，默认展开
- 悬浮导航按钮支持一键展开/折叠
- 严重问题卡片展示以下信息：
  - 提交人名称
  - 文件路径
  - 问题行号
  - 问题描述
  - 改进建议
- 所有问题按严重程度排序显示

### 技术栈保持

- Python 3.8+
- GitLab API
- OpenAI 兼容格式的大模型 API
- Jinja2 模板引擎
- ThreadPoolExecutor 并发处理

---

## [v1.0.0] - 2025-11-10

### 初始版本

- **核心功能**：
  - GitLab 集成，自动拉取代码差异
  - 大模型代码评审
  - 多格式报告生成（HTML/Markdown/JSON）
  - 按提交人分组统计

- **配置系统**：
  - YAML 配置文件
  - 支持本地配置覆盖（config.local.yaml）
  - 可配置的评审规则

- **性能优化**：
  - ThreadPoolExecutor 并发评审
  - 可配置的并发度（max_workers）

- **日志系统**：
  - 文件日志支持
  - 轮转日志处理
  - 多级别日志记录

- **深度思考模式**：
  - 支持通过消息标签（/think, /no_think）切换
  - 支持全局配置启用

- **分支管理**：
  - 支持指定源分支和基准分支
  - 基准分支为必输参数

---

## 版本规划

### 未来规划

- [ ] 评审规则模板库
- [ ] Web UI 界面
- [ ] 评审历史记录
- [ ] 自定义报告主题
- [ ] Webhook 集成自动触发评审
- [ ] 评审结果数据库存储
- [ ] 集成gerrit

---

## 贡献指南

在做出重要变更时，请：
1. 更新相关的代码文档和注释
2. 更新本 CHANGELOG.md 文件
3. 在提交说明中引用相关的版本号

