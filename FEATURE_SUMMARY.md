# Excel报告 - 评审规则列功能说明

## 功能概览

现已为Excel报告添加了**"评审规则"列**，用于展示每个代码问题所命中的配置评审规则。

## 修改内容

### 1. review_engine.py - 规则匹配逻辑
- **新增方法**: `collect_review_rules_with_category()` 
  - 目的：收集所有启用的评审规则，并建立规则文本与分类的映射关系
  - 返回：字典类型，key为规则文本，value为分类名称

- **修改方法**: `review_diff()`
  - 为每个问题自动匹配对应的评审规则
  - 添加两个新字段到问题对象：
    - `matched_rule`: 匹配的规则文本（若有匹配）
    - `matched_rule_category`: 匹配的规则分类（若有匹配）
  - 匹配策略：
    1. **精确分类匹配**：检查问题分类与规则分类是否包含关系
    2. **关键词匹配**：若精确匹配失败，通过关键词分析进行匹配

### 2. excel_formatter.py - Excel表格呈现
- **修改方法**: `_create_issues_sheet()`
  - 增加第9列："评审规则"
  - 列宽设置为25字符
  - 表头样式与其他列一致（蓝色背景、白色字体）
  
- **规则显示格式**：
  - 有分类和规则时：`[分类名] 规则文本`（如：`[代码风格] 检查代码格式是否符合团队规范`）
  - 仅有规则无分类：显示规则文本
  - 仅有分类无规则：显示分类名
  - 无匹配：显示 `N/A`

- **样式应用**：
  - 规则列受严重程度颜色影响（与其他数据列一致）
  - 支持文本换行显示

## 使用示例

### 配置示例（config.yaml）
```yaml
review_rules:
  代码风格:
    enabled: true
    rules:
      - "检查代码格式是否符合团队规范"
      - "检查命名是否清晰且符合约定"
  
  安全性:
    enabled: true
    rules:
      - "检查是否有SQL注入风险"
      - "检查是否有XSS漏洞风险"
  
  性能:
    enabled: true
    rules:
      - "检查是否有不必要的循环嵌套"
      - "检查数据库查询是否优化"
```

### 实际报告效果

Excel报告"问题详情"表中的列顺序：

| 严重程度 | 提交人 | 文件 | 行号 | 方法 | 问题描述 | 改进建议 | 问题代码 | **评审规则** |
|---------|-------|------|------|------|---------|---------|---------|------------|
| 严重 | 张三 | app.py | 42 | login() | SQL注入风险 | 使用参数化查询 | ... | [安全性] 检查是否有SQL注入风险 |
| 主要 | 李四 | utils.py | 128 | process() | 循环嵌套过深 | 优化算法 | ... | [性能] 检查是否有不必要的循环嵌套 |
| 次要 | 王五 | config.py | 15 | - | 代码格式不一致 | 统一格式 | ... | [代码风格] 检查代码格式是否符合团队规范 |

## 测试验证

已通过 `test_rule_matching.py` 验证规则匹配功能：

✓ 规则到分类的映射正确建立
✓ 精确分类匹配有效
✓ 关键词匹配作为后备方案可用
✓ 无匹配时的默认处理正确

## 数据流说明

```
配置（config.yaml）
    ↓
ReviewEngine.collect_review_rules_with_category() - 建立规则映射
    ↓
review_diff() - 为每个问题匹配规则
    ↓
问题对象增加 matched_rule 和 matched_rule_category 字段
    ↓
ExcelFormatter._create_issues_sheet() - 第9列显示规则信息
    ↓
Excel报告（*.xlsx）- "评审规则"列展示规则信息
```

## 兼容性

- ✓ 现有报告生成流程不受影响
- ✓ HTML格式报告暂不受影响（可后续扩展）
- ✓ 如果问题无法匹配规则，显示 `N/A`（不会报错）
- ✓ 支持任意数量的规则和分类

## 后续优化建议

1. 在HTML报告中也显示评审规则信息
2. 支持按规则分类筛选问题
3. 添加规则命中率统计（每条规则发现了多少问题）
4. 支持规则的自定义显示名称（不同于分类名）
