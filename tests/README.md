# 代码评审系统测试文档

本目录包含代码评审系统的测试套件，包括功能集成测试、数据库连接测试和定时任务调度测试。

## 测试文件

### 1. test_database_connection.py
**数据库连接测试**

测试 MySQL 数据库的连接、表结构创建、数据增删改查操作。

**测试内容**：
- 数据库连接
- 创建表结构
- 保存评审数据
- 查询评审数据
- 列表查询
- 更新问题状态
- 统计查询
- 删除评审记录
- 连接错误处理

### 2. test_scheduler.py
**定时任务调度测试**

测试 APScheduler 调度器的任务调度、执行和管理功能。

**测试内容**：
- 调度器初始化
- 调度器启动和停止
- 间隔调度
- Cron 表达式调度
- 每日定时调度
- 每周定时调度
- 任务列表查询
- 取消任务
- 多任务调度
- 带参数的任务
- 任务异常处理

### 3. test_integration.py
**功能集成测试**

测试系统完整的评审流程，包括配置加载、GitLab 集成、LLM 评审、报告生成和数据存储。

**测试内容**：
- 配置加载
- GitLab 连接
- LLM 连接
- 评审引擎初始化
- 报告生成器
- 数据库存储集成
- 端到端工作流

### 4. run_tests.py
**测试运行器**

统一运行所有测试套件的工具。

## 运行测试

### 运行所有测试

```bash
cd tests
python run_tests.py
```

或者

```bash
python run_tests.py all
```

### 运行单个测试套件

**数据库测试**：
```bash
python run_tests.py database
```

**调度器测试**：
```bash
python run_tests.py scheduler
```

**集成测试**：
```bash
python run_tests.py integration
```

### 直接运行测试文件

也可以直接运行单个测试文件：

```bash
python test_database_connection.py
python test_scheduler.py
python test_integration.py
```

## 测试前准备

### 1. 配置文件

确保项目根目录存在有效的配置文件：
- `config.yaml` - 基础配置
- `config.local.yaml` - 本地配置（可选）

### 2. 数据库测试准备

如果要运行数据库测试，需要：
- MySQL 5.7+ 或 MariaDB 10.2+
- 在配置文件中启用存储功能：
  ```yaml
  storage:
    enabled: true
    connection:
      host: localhost
      port: 3306
      username: your_username
      password: your_password
      database: code_review_test
      charset: utf8mb4
  ```
- 运行数据库初始化脚本：
  ```bash
  python init_database.py
  ```

### 3. 集成测试准备

如果要运行完整的集成测试，需要：
- 有效的 GitLab 访问令牌和项目配置
- 有效的 LLM API 配置
- 至少有两个可对比的分支

如果没有这些条件，相关测试会自动跳过。

## 测试输出

测试运行时会输出详细的执行信息：

```
======================================================================
数据库连接测试
======================================================================

============================================================
执行测试: test_01_database_connection
============================================================
测试数据库连接...
✓ 数据库连接成功
✓ 连接字符串格式正确
✓ 字符集: utf8mb4

============================================================
执行测试: test_02_create_tables
============================================================
测试创建表结构...
删除旧表（如果存在）...
创建新表...
✓ review_records 表创建成功，包含 2 个索引
✓ review_issues 表创建成功，包含 3 个索引

...
```

最后会显示测试总结：

```
======================================================================
测试总结
======================================================================
总测试数: 9
成功: 9
失败: 0
错误: 0
跳过: 0
```

## 常见问题

### 1. 数据库连接失败

**问题**：测试提示 "MySQL连接失败"

**解决**：
- 检查 MySQL 服务是否运行
- 验证配置文件中的连接信息是否正确
- 确认数据库用户有足够的权限
- 检查防火墙设置

### 2. 测试被跳过

**问题**：某些测试显示 "skipped"

**原因**：
- 配置文件缺少必需的配置项
- 存储功能未启用
- 缺少 GitLab 或 LLM 配置

**解决**：根据提示信息补充相应的配置

### 3. 集成测试失败

**问题**：端到端测试失败

**可能原因**：
- GitLab 项目配置错误
- 分支不存在
- LLM API 调用失败
- 网络问题

**解决**：
- 检查 GitLab 连接和项目配置
- 验证分支名称是否正确
- 测试 LLM API 是否可用
- 检查网络连接

## 测试覆盖范围

当前测试覆盖以下功能：

✅ 数据库连接和操作
✅ 表结构创建和验证
✅ 数据增删改查
✅ 调度器初始化和管理
✅ 任务调度和执行
✅ 配置加载
✅ 组件初始化
✅ 报告生成
✅ 端到端工作流

## 扩展测试

如需添加新测试，可以：

1. 创建新的测试文件 `test_xxx.py`
2. 继承 `unittest.TestCase`
3. 添加测试方法（以 `test_` 开头）
4. 在 `run_tests.py` 中注册新测试

示例：

```python
import unittest

class TestNewFeature(unittest.TestCase):
    def setUp(self):
        """测试前准备"""
        pass
    
    def test_something(self):
        """测试某个功能"""
        self.assertTrue(True)
    
    def tearDown(self):
        """测试后清理"""
        pass

if __name__ == '__main__':
    unittest.main()
```
